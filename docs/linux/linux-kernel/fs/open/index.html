<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="open()在Linux内核的实现(2)-路径查找 详解应用层open函数如何调用到底层驱动中xxx_open函数 打开一个文件操作系统做了什么？
一、总述 # 二、代码流程 # 1. SYSCALL_DEFINE3 从系统调用定义开始 # 1// fs/open.c 2SYSCALL_DEFINE3(open, const char __user *, filename, int, flags, umode_t, mode) 3{ 4	if (force_o_largefile()) 5	flags |= O_LARGEFILE; 6	return do_sys_open(AT_FDCWD, filename, flags, mode); 7} 8 9// fs/open.c 10long do_sys_open(int dfd, const char __user *filename, int flags, umode_t mode) 11{ 12	struct open_how how = build_open_how(flags, mode); 13	return do_sys_openat2(dfd, filename, &amp;how); 14} 1.1. 先构造如何打开的结构体，主要是处理flag # 1// fs/open.">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="open系统调用" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:url" content="/docs/linux/linux-kernel/fs/open/" />
<title>open系统调用 | 技术的路上奔跑</title>
<link rel="manifest" href="../../../../../manifest.json">
<link rel="icon" href="../../../../../favicon.png" type="image/x-icon">
<link rel="stylesheet" href="../../../../../book.min.33a48f5432973b8ff9a82679d9e45d67f2c15d4399bd2829269455cfe390b5e8.css" integrity="sha256-M6SPVDKXO4/5qCZ52eRdZ/LBXUOZvSgpJpRVz&#43;OQteg=">
<script defer src="../../../../../en.search.min.ffb26c0b822eb80e169fe51ff5a5fe446b7ea107731835d986761125ea031367.js" integrity="sha256-/7JsC4IuuA4Wn&#43;Uf9aX&#43;RGt&#43;oQdzGDXZhnYRJeoDE2c="></script>

<script defer src="../../../../../sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js" integrity="sha256-b2&#43;Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC&#43;NdcPIvZhzk="></script>
<link rel="alternate" type="application/rss+xml" href="../../../../../docs/linux/linux-kernel/fs/open/index.xml" title="技术的路上奔跑" />
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

<link rel="stylesheet" href="../../../../../katex/katex.min.css">
<script src="../../../../../katex/katex.min.js"></script>
<script src="../../../../../katex/auto-render.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    renderMathInElement(document.body, {
      delimiters: [
        { left: "$$", right: "$$", display: true },
        { left: "$", right: "$", display: false }
      ]
    });
  });
</script>



<script src="../../../../../lib/plantuml-encoder.min.js" integrity="sha256-Qsk2KRBCN5qVZX7B+8+2IvQl1Aqc723qV1tBCQaVoqo=" crossorigin="anonymous"></script>
<script>
document.addEventListener("DOMContentLoaded", function(){
  let plantumlPrefix = "language-plantuml";
  Array.prototype.forEach.call(document.querySelectorAll("[class^=" + plantumlPrefix + "]"), function(code){
    let image = document.createElement("IMG");
    image.loading = 'lazy'; 
    image.src = 'https://www.plantuml.com/plantuml/svg/~1' + plantumlEncoder.encode(code.innerText);
    code.style.display = 'none';
    code.parentNode.style = 'text-align: center; margin: 0; padding: 0; background-color: transparent;';

    
    
    let div = document.createElement("DIV");
    div.className = "post-img-view";
    let a = document.createElement("A");
    a.setAttribute("data-fancybox", "gallery");
    a.setAttribute("href", image.src);
    a.appendChild(image);
    div.appendChild(a);
    code.parentNode.insertBefore(div, code);
    
  });
});
</script>



<script src="../../../../../lib/fancybox/jquery.min.js"></script>
<link rel="stylesheet" href="../../../../../lib/fancybox/jquery.fancybox.min.css" />
<script src="../../../../../lib/fancybox/jquery.fancybox.min.js"></script>


  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="../../../../../"><span>技术的路上奔跑</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  



  
  <ul>
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-076945525d27fc883dc64d169725123d" class="toggle"  />
    <label for="section-076945525d27fc883dc64d169725123d" class="flex justify-between">
      <a href="../../../../../docs/c&#43;&#43;/" class="">C&#43;&#43;源码分析记录</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/c&#43;&#43;/macro/" class="">预定义宏</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/c&#43;&#43;/move/" class="">std::move</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/c&#43;&#43;/shared_ptr/" class="">std::shared_ptr</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-6ae1a891fb3a3f71d71273fc61b29b76" class="toggle" checked />
    <label for="section-6ae1a891fb3a3f71d71273fc61b29b76" class="flex justify-between">
      <a role="button" class="">linux</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-3a06e930057f0966216e8ee296319246" class="toggle" checked />
    <label for="section-3a06e930057f0966216e8ee296319246" class="flex justify-between">
      <a href="../../../../../docs/linux/linux-kernel/" class="">linux内核源码分析记录</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/compile-thinking/" class="">编译思想</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-fe3499b386047030cefed47c8171acfe" class="toggle"  />
    <label for="section-fe3499b386047030cefed47c8171acfe" class="flex justify-between">
      <a role="button" class="">数据结构</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/data-structures/container_of/" class="">container_of() 根据成员地址找其所在结构体</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/data-structures/atomic/" class="">atomic 原子变量</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/data-structures/hashtable/" class="">hashtable 哈希表</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/data-structures/kfifo/" class="">kfifo 无锁循环队列</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/data-structures/list/" class="">list 链表</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/data-structures/rbtree/" class="">rbtree 红黑树</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/data-structures/rcu/" class="">RCU Read-Copy-Update</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-61e0ef8b04de577fbdc7b126d08efe69" class="toggle"  />
    <label for="section-61e0ef8b04de577fbdc7b126d08efe69" class="flex justify-between">
      <a role="button" class="">/drivers/ 驱动部分</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-ae532a140ecd7bf2d7c22e0b1a16962f" class="toggle"  />
    <label for="section-ae532a140ecd7bf2d7c22e0b1a16962f" class="flex justify-between">
      <a role="button" class="">net/ 网卡驱动部分</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/drivers/net/common/" class="">通用网络驱动开发知识</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/drivers/net/igb/" class="">Igb</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/drivers/keyboard/" class="">键盘驱动</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-2e9314dfe8a7648843991b528610d749" class="toggle"  />
    <label for="section-2e9314dfe8a7648843991b528610d749" class="flex justify-between">
      <a role="button" class="">/net/ 网络部分</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/net/common/" class="">网络数据包处理流程</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-fc939877a55e0f79c88a1c64432710ef" class="toggle"  />
    <label for="section-fc939877a55e0f79c88a1c64432710ef" class="flex justify-between">
      <a role="button" class="">socket</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/net/socket/socket/" class="">socket总述</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/net/socket/sendmsg/" class="">sendmsg</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/net/socket/recvmsg/" class="">recvmsg</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/net/iptables/" class="">Iptables</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-0a7f1c84540241f1c6f1800de49a7720" class="toggle"  />
    <label for="section-0a7f1c84540241f1c6f1800de49a7720" class="flex justify-between">
      <a role="button" class="">ipv4/ ipv4的处理部分</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/net/ipv4/ipv4/" class="">Ipv4</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/net/ipv4/tcp/" class="">tcp</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/net/ipv4/udp/" class="">udp</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-108538e770a9cc3fc0b35a5067536d07" class="toggle"  />
    <label for="section-108538e770a9cc3fc0b35a5067536d07" class="flex justify-between">
      <a role="button" class="">ipv6/ ipv6的处理部分</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/net/ipv6/inet6/" class="">Inet6</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-82fca42832e0f5862765245480c6d50a" class="toggle"  />
    <label for="section-82fca42832e0f5862765245480c6d50a" class="flex justify-between">
      <a role="button" class="">unix/ unix的处理部分</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/net/unix/unix/" class="">Unix</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/net/bridge/" class="">linux网桥</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/net/epoll/" class="">Epoll</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/net/poll/" class="">Poll</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/net/select/" class="">Select</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/net/sk_buff/" class="">sk_buff 内核中数据包结构体</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-ccd466ff3139a06e35e5768247dedcda" class="toggle"  />
    <label for="section-ccd466ff3139a06e35e5768247dedcda" class="flex justify-between">
      <a role="button" class="">/arch/ cpu体系架构</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-f796c2cc14778d5a798d7af8ab5b83b3" class="toggle"  />
    <label for="section-f796c2cc14778d5a798d7af8ab5b83b3" class="flex justify-between">
      <a href="../../../../../docs/linux/linux-kernel/arch/common/" class="">公共处理方式</a>
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-17eb2a36dc4fa094b5493959ccab63bc" class="toggle"  />
    <label for="section-17eb2a36dc4fa094b5493959ccab63bc" class="flex justify-between">
      <a role="button" class="">x86/ x86体系</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/arch/x86/boot/" class="">x86启动过程</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/arch/x86/register/" class="">特殊寄存器</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/arch/x86/gdt-idt-ldt-tss-tgd/" class="">gdt/idt/ldt/tss/tgd</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/arch/x86/timer/" class="">定时器设定</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/arch/x86/early-printk/" class="">早期日志输出</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-c0c473dcbf34f130a01d125d9e77f9a9" class="toggle" checked />
    <label for="section-c0c473dcbf34f130a01d125d9e77f9a9" class="flex justify-between">
      <a role="button" class="">/fs/ 文件部分</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/fs/common/" class="">文件系统总述</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/fs/open/" class="active">open系统调用</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/fs/inotify/" class="">Inotify</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-2f4734425ea4bf70ec20a77f7fe621dd" class="toggle"  />
    <label for="section-2f4734425ea4bf70ec20a77f7fe621dd" class="flex justify-between">
      <a role="button" class="">/kernel/ 内核运行主要代码</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-eb76a8b10e091e71a1250b7c433d77db" class="toggle"  />
    <label for="section-eb76a8b10e091e71a1250b7c433d77db" class="flex justify-between">
      <a role="button" class="">/kernel/lockng/ 锁相关</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/kernel/locking/bit_spinlock/" class="">bit_spinlock</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/kernel/locking/qspinlock/" class="">qspinlock</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-b5a08711df6a5e37561d8b68c9439067" class="toggle"  />
    <label for="section-b5a08711df6a5e37561d8b68c9439067" class="flex justify-between">
      <a href="../../../../../docs/linux/linux-kernel/kernel/sched/" class="">/kernel/sched/ 进程调度</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/kernel/sched/schedule/" class="">主调度器</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-1e39884438084c2c1fc67e916eb2b208" class="toggle"  />
    <label for="section-1e39884438084c2c1fc67e916eb2b208" class="flex justify-between">
      <a href="../../../../../docs/linux/linux-kernel/kernel/cgroup/" class="">/kernel/cgroup/ cgroup处理</a>
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-f1341bef3dd7f66ab15601ff5c2bb167" class="toggle"  />
    <label for="section-f1341bef3dd7f66ab15601ff5c2bb167" class="flex justify-between">
      <a href="../../../../../docs/linux/linux-kernel/kernel/watchdog/" class="">/kernel/watchdog* 看门狗</a>
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/kernel/timer/" class="">内核计时和定时器</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/kernel/time/" class="">时间系统</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-9e5b7eb3577a3bb9311b9512acca784c" class="toggle"  />
    <label for="section-9e5b7eb3577a3bb9311b9512acca784c" class="flex justify-between">
      <a role="button" class="">中断</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/intterupt/common/" class="">上半部和下半部</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-7136deee92473c69f24df09271c02b70" class="toggle"  />
    <label for="section-7136deee92473c69f24df09271c02b70" class="flex justify-between">
      <a role="button" class="">/mm/ 内存管理</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/mm/kmem_cache/" class="">kmem_cache</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/linux-kernel/public-micro/" class="">公共宏的一些定义</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-89208b0ad894e0bedeaaff6a9f182258" class="toggle"  />
    <label for="section-89208b0ad894e0bedeaaff6a9f182258" class="flex justify-between">
      <a role="button" class="">调试技术</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-4ae4ec450d01e14f8d498fceca77e47f" class="toggle"  />
    <label for="section-4ae4ec450d01e14f8d498fceca77e47f" class="flex justify-between">
      <a role="button" class="">proc目录内容详解</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/debug/proc/diskstats/" class="">/proc/diskstats 磁盘信息</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/debug/ftrace/" class="">ftrace</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/debug/systemtap/" class="">systemtap</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-d7ea361bf72968532bcfe65fe25e5cd9" class="toggle"  />
    <label for="section-d7ea361bf72968532bcfe65fe25e5cd9" class="flex justify-between">
      <a role="button" class="">内核问题排查记录</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-da8cfb336c9632e4b8d863855abae391" class="toggle"  />
    <label for="section-da8cfb336c9632e4b8d863855abae391" class="flex justify-between">
      <a role="button" class="">宕机vmcore分析</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/kernel-troubleshooting/crash/01-netfilter-driver-crash/" class="">1. netfilter驱动使用sk错误引发宕机</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/kernel-troubleshooting/crash/02-hung-task-crash/" class="">2. Kernel panic - not syncing: hung_task: blocked tasks</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/linux/kernel-troubleshooting/knowledge/" class="">知识性说明</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-81ac4d0ce2be51263b8d525fd8e2f1f6" class="toggle"  />
    <label for="section-81ac4d0ce2be51263b8d525fd8e2f1f6" class="flex justify-between">
      <a href="../../../../../docs/glibc/" class="">glibc源码分析记录</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-1a3b279e0f293c5c3a083f9323ca8ab2" class="toggle"  />
    <label for="section-1a3b279e0f293c5c3a083f9323ca8ab2" class="flex justify-between">
      <a role="button" class="">nss: Name Service Switch</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-12c635147ca4f050649e8f9130f1ba3c" class="toggle"  />
    <label for="section-12c635147ca4f050649e8f9130f1ba3c" class="flex justify-between">
      <a role="button" class="">hosts dns解析服务</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/glibc/nss/hosts/dns/" class="">dns 根据/etc/resolv.conf发包处理</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/glibc/nss/hosts/files/" class="">files 读取/etc/hosts文件</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-e66e2e478c81786f553bd82d3931b216" class="toggle"  />
    <label for="section-e66e2e478c81786f553bd82d3931b216" class="flex justify-between">
      <a href="../../../../../docs/mysql/" class="">mysql源码分析记录</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/mysql/compile/" class="">编译和调试方法</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-f8bd884eebd2f3fa4437f5c30e95d87b" class="toggle"  />
    <label for="section-f8bd884eebd2f3fa4437f5c30e95d87b" class="flex justify-between">
      <a href="../../../../../docs/openssl/" class="">openssl源码分析记录</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-79f5d582b25e0ba116147e70d7c37d9b" class="toggle"  />
    <label for="section-79f5d582b25e0ba116147e70d7c37d9b" class="flex justify-between">
      <a role="button" class="">crypto 加解密库</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/openssl/crypto/X509/" class="">X509证书</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-b0d378e2e51e9e43c0fd54b7f68d5d64" class="toggle"  />
    <label for="section-b0d378e2e51e9e43c0fd54b7f68d5d64" class="flex justify-between">
      <a role="button" class="">ssl ssl协议相关</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/openssl/ssl/certificate/" class="">Certificate</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/openssl/ssl/certificateVerify/" class="">Certificate Verify</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-ad6c2bf4e759ec71c24d3649b1af28e6" class="toggle"  />
    <label for="section-ad6c2bf4e759ec71c24d3649b1af28e6" class="flex justify-between">
      <a role="button" class="">引擎开发</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/openssl/engines/rsa/" class="">rsa普密ukey</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-2b0f9c71b96dae88f32ac3cee96b20d0" class="toggle"  />
    <label for="section-2b0f9c71b96dae88f32ac3cee96b20d0" class="flex justify-between">
      <a role="button" class="">systemd源码分析记录</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/systemd/dns/" class="">dns 根据/etc/resolv.conf发包处理</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-f55a7674027409a03b8a5abb4bc297a8" class="toggle"  />
    <label for="section-f55a7674027409a03b8a5abb4bc297a8" class="flex justify-between">
      <a role="button" class="">nginx与openresty源码分析记录</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-31add6f61f1172621b97f8a589c1d0b2" class="toggle"  />
    <label for="section-31add6f61f1172621b97f8a589c1d0b2" class="flex justify-between">
      <a href="../../../../../docs/nginx/nginx/" class="">nginx</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/nginx/nginx/common/" class="">nginx结构综述</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-fff5261d3f813bb84c350c416cb2fb96" class="toggle"  />
    <label for="section-fff5261d3f813bb84c350c416cb2fb96" class="flex justify-between">
      <a href="../../../../../docs/nginx/nginx/http/" class="">http模块</a>
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-f4402e173ff6e0baf39c7dcabe4cc055" class="toggle"  />
    <label for="section-f4402e173ff6e0baf39c7dcabe4cc055" class="flex justify-between">
      <a role="button" class="">stream模块</a>
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-17591ec0ca9929e17ca9b0e68c7f4109" class="toggle"  />
    <label for="section-17591ec0ca9929e17ca9b0e68c7f4109" class="flex justify-between">
      <a href="../../../../../docs/nginx/openresty/" class="">openresty扩展组件</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-ac6c60f4cffbffe56d10067a0daed9b7" class="toggle"  />
    <label for="section-ac6c60f4cffbffe56d10067a0daed9b7" class="flex justify-between">
      <a href="../../../../../docs/nginx/openresty/stream/" class="">https://github.com/openresty/stream-lua-nginx-module</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/nginx/openresty/stream/socket-tcp/" class="">ngx_stream_lua_socket_tcp.c</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-da0768733ed83a1a185c822afd62afca" class="toggle"  />
    <label for="section-da0768733ed83a1a185c822afd62afca" class="flex justify-between">
      <a role="button" class="">考试准备</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-73f081c9d6184c17d75a11eb0c89f950" class="toggle"  />
    <label for="section-73f081c9d6184c17d75a11eb0c89f950" class="flex justify-between">
      <a role="button" class="">系统架构师</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-3678bd996217536cb45684f08acbf2d5" class="toggle"  />
    <label for="section-3678bd996217536cb45684f08acbf2d5" class="flex justify-between">
      <a role="button" class="">大并发架构</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/examination/system-architect/large-concurrency/common/" class="">前言和综述</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/examination/system-architect/large-concurrency/reliability/" class="">可靠性</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/examination/system-architect/large-concurrency/proctical-scene/" class="">实践场景</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-e78103f8358bcc8897b2665157a6ac17" class="toggle"  />
    <label for="section-e78103f8358bcc8897b2665157a6ac17" class="flex justify-between">
      <a role="button" class="">读书和学习笔记</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/examination/system-architect/book-study/reliability/" class="">可靠性设计</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/examination/system-architect/book-study/designing-data-intensive-application/" class="">数据密集型应用系统设计</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>系统工程</span>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-bc467201b327634cf4794420f221e449" class="toggle"  />
    <label for="section-bc467201b327634cf4794420f221e449" class="flex justify-between">
      <a href="../../../../../docs/ctf/" class="">ctf知识总结</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-5c98ee620834c5b46fb9c98c912f3a58" class="toggle"  />
    <label for="section-5c98ee620834c5b46fb9c98c912f3a58" class="flex justify-between">
      <a role="button" class="">知识性总结</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-efb38f77116c50bfef7a34437bcb0d09" class="toggle"  />
    <label for="section-efb38f77116c50bfef7a34437bcb0d09" class="flex justify-between">
      <a role="button" class="">加解密编码等算法</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/ctf/knowledge/encoder-decoder/algorithm/" class="">hash和编码算法列表</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-048232ff144b12ee355b2a18ecb86c32" class="toggle"  />
    <label for="section-048232ff144b12ee355b2a18ecb86c32" class="flex justify-between">
      <a role="button" class="">压缩和解压缩</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/ctf/knowledge/compress/zip/" class="">zip</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-287675e4fff40951adcbf3f3bc57df6d" class="toggle"  />
    <label for="section-287675e4fff40951adcbf3f3bc57df6d" class="flex justify-between">
      <a role="button" class="">文件相关</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/ctf/knowledge/file/file-struct/" class="">文件格式</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-521980a8aaa52145eac6f7bd8ae2a51e" class="toggle"  />
    <label for="section-521980a8aaa52145eac6f7bd8ae2a51e" class="flex justify-between">
      <a role="button" class="">buuoj.cn的题目</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-dab01071fb6c7505b5567d9327443dcd" class="toggle"  />
    <label for="section-dab01071fb6c7505b5567d9327443dcd" class="flex justify-between">
      <a role="button" class="">misc</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/ctf/buuctf/misc/%E9%9D%A2%E5%85%B7%E4%B8%8B%E7%9A%84flag/" class="">面具下的flag</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-8bb89e37bc8ac94ed7933c2c15518f8c" class="toggle"  />
    <label for="section-8bb89e37bc8ac94ed7933c2c15518f8c" class="flex justify-between">
      <a role="button" class="">AI相关</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/ai/keywords/" class="">名词解释和学习大纲</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-1cc51252e9449a6be453972b2b6526e1" class="toggle"  />
    <label for="section-1cc51252e9449a6be453972b2b6526e1" class="flex justify-between">
      <a role="button" class="">计算机视觉</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/ai/cv/minst/" class="">minst手写数字识别——神经网络实战笔记</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-20038bcc21ca3d914920842c4a32533d" class="toggle"  />
    <label for="section-20038bcc21ca3d914920842c4a32533d" class="flex justify-between">
      <a href="../../../../../docs/leetcode/" class="">LeetCode刷题思路总结</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-e557ddd3240c9349f7b073a0a626b78b" class="toggle"  />
    <label for="section-e557ddd3240c9349f7b073a0a626b78b" class="flex justify-between">
      <a role="button" class="">简单</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode1/" class="">1. Two Sum</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode9/" class="">9. Palindrome Number</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode13/" class="">13. Roman to Integer</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode20/" class="">20. Valid Parentheses</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode101/" class="">101. Symmetric Tree</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode706/" class="">706. Design HashMap</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode1694/" class="">1694. Reformat Phone Number</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode2399/" class="">2399. Check Distances Between Same Letters</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode2413/" class="">2413. Smallest Even Multiple</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode2418/" class="">2418. Sort the People</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode2441/" class="">2441. Largest Positive Integer That Exists With Its Negative</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode2446/" class="">2446. Determine if Two Events Have Conflict</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode2455/" class="">2455. Average Value of Even Numbers That Are Divisible by Three</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode2460/" class="">2460. Apply Operations to an Array</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode2469/" class="">2469. Convert the Temperature</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode2475/" class="">2475. Number of Unequal Triplets in Array</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode2485/" class="">2485. Find the Pivot Integer</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode2490/" class="">2490. Circular Sentence</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode2500/" class="">2500. Delete Greatest Value in Each Row</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode2515/" class="">2515. Shortest Distance to Target String in a Circular Array</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode2520/" class="">2520. Count the Digits That Divide a Number</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode2529/" class="">2529. Maximum Count of Positive Integer and Negative Integer</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode2535/" class="">2535. Difference Between Element Sum and Digit Sum of an Array</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode2562/" class="">2562. Find the Array Concatenation Value</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode2570/" class="">2570. Merge Two 2D Arrays by Summing Values</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode2574/" class="">2574. Left and Right Sum Differences</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode2582/" class="">2582. Pass the Pillow</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode2595/" class="">2595. Number of Even and Odd Bits</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode2600/" class="">2600. K Items With the Maximum Sum</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode2609/" class="">2609. Find the Longest Balanced Substring of a Binary String</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode2614/" class="">2614. Prime In Diagonal</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode2643/" class="">2643. Row With Maximum Ones</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode2644/" class="">2644. Find the Maximum Divisibility Score</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode2682/" class="">2682. Find the Losers of the Circular Game</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode2710/" class="">2710. Remove Trailing Zeros From a String</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode2716/" class="">2716. Minimize String Length</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode2717/" class="">2717. Semi-Ordered Permutation</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode2733/" class="">2733. Neither Minimum nor Maximum</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode2739/" class="">2739. Total Distance Traveled</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode2859/" class="">2859. Sum of Values at Indices With K Set Bits</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/simple/leetcode2860/" class="">2860. Happy Students</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-dbe51e7e4a89495069ffe18bd5d28a03" class="toggle"  />
    <label for="section-dbe51e7e4a89495069ffe18bd5d28a03" class="flex justify-between">
      <a role="button" class="">中等</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode3/" class="">3. Longest Substring Without Repeating Characters</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode5/" class="">5. Longest Palindromic Substring</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode6/" class="">6. ZigZag Conversion</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode7/" class="">7. Reverse Integer</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode8/" class="">8. String to Integer (atoi)</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode11/" class="">11. Container With Most Water</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode12/" class="">12. Integer to Roman</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode18/" class="">18. 4Sum</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode155/" class="">155. Min Stack</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode322/" class="">322. Coin Change</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode658/" class="">658. Find K Closest Elements</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode948/" class="">948. Bag of Tokens</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode1169/" class="">1169. Invalid Transactions</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode1352/" class="">1352. Product of the Last K Numbers</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2400/" class="">2400. Number of Ways to Reach a Position After Exactly k Steps</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2401/" class="">2401. Longest Nice Subarray</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2414/" class="">2414. Length of the Longest Alphabetical Continuous Substring</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2415/" class="">2415. Reverse Odd Levels of Binary Tree</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2419/" class="">2419. Longest Subarray With Maximum Bitwise AND</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2420/" class="">2420. Find All Good Indices</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2442/" class="">2442. Count Number of Distinct Integers After Reverse Operations</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2443/" class="">2443. Sum of Number and Its Reverse</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2447/" class="">2447. Number of Subarrays With GCD Equal to K</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2456/" class="">2456. Most Popular Video Creator</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2457/" class="">2457. Minimum Addition to Make Integer Beautiful</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2461/" class="">2461. Maximum Sum of Distinct Subarrays With Length K</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2462/" class="">2462. Total Cost to Hire K Workers</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2476/" class="">2476. Closest Nodes Queries in a Binary Search Tree</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2486/" class="">2486. Append Characters to String to Make Subsequence</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2487/" class="">2487. Remove Nodes From Linked List</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2491/" class="">2491. Circular Sentence</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2492/" class="">2492. Circular Sentence</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2501/" class="">2501. Longest Square Streak in an Array</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2502/" class="">2502. Longest Square Streak in an Array</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2516/" class="">2516. Take K of Each Character From Left and Right</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2517/" class="">2517. Maximum Tastiness of Candy Basket</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2521/" class="">2521. Distinct Prime Factors of Product of Array</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2522/" class="">2522. Partition String Into Substrings With Values at Most K</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2523/" class="">2523. Closest Prime Numbers in Range</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2530/" class="">2530. Maximum Count of Positive Integer and Negative Integer</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2531/" class="">2531. Make Number of Distinct Characters Equal</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2536/" class="">2536. Increment Submatrices by One</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2537/" class="">2537. Count the Number of Good Subarrays</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2563/" class="">2563. Count the Number of Fair Pairs</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2564/" class="">2564. Substring XOR Queries</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2571/" class="">2571. Minimum Operations to Reduce an Integer to 0</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2572/" class="">2572. Count the Number of Square-Free Subsets</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2575/" class="">2575. Find the Divisibility Array of a String</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2576/" class="">2576. Find the Maximum Number of Marked Indices</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2583/" class="">2583. Kth Largest Sum in a Binary Tree</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2596/" class="">2596. Check Knight Tour Configuration</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2597/" class="">2597. The Number of Beautiful Subsets</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2598/" class="">2598. Smallest Missing Non-negative Integer After Operations</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2601/" class="">2601. Prime Subtraction Operation</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2602/" class="">2602. Minimum Operations to Make All Array Elements Equal</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2610/" class="">2610. Convert an Array Into a 2D Array With Conditions</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2611/" class="">2611. Mice and Cheese</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2615/" class="">2615. Sum of Distances</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2645/" class="">2645. Find the Maximum Divisibility Score</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2683/" class="">2683. Neighboring Bitwise XOR</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2684/" class="">2684. Maximum Number of Moves in a Grid</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2685/" class="">2685. Count the Number of Complete Components</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2711/" class="">2711. Difference of Number of Distinct Values on Diagonals</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2712/" class="">2712. Minimum Cost to Make All Characters Equal</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2718/" class="">2718. Sum of Matrix After Queries</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2734/" class="">2734. Lexicographically Smallest String After Substring Operation</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2735/" class="">2735. Collecting Chocolates</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2740/" class="">2740. Find the Value of the Partition</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/medium/leetcode2741/" class="">2741. Special Permutations</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-42eecace07f2c55adbf8c2fda3b6b016" class="toggle"  />
    <label for="section-42eecace07f2c55adbf8c2fda3b6b016" class="flex justify-between">
      <a role="button" class="">困难</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/hard/leetcode4/" class="">4. Median of Two Sorted Arrays</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/hard/leetcode10/" class="">10. Regular Expression Matching</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/hard/leetcode41/" class="">41. First Missing Positive</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/hard/leetcode327/" class="">327. Count of Range Sum</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/hard/leetcode440/" class="">440. K-th Smallest in Lexicographical Order</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/hard/leetcode736/" class="">736. Parse Lisp Expression</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/hard/leetcode864/" class="">864. Shortest Path to Get All Keys</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/hard/leetcode2444/" class="">2444. Count Subarrays With Fixed Bounds</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/hard/leetcode2448/" class="">2448. Minimum Cost to Make Array Equal</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/hard/leetcode2488/" class="">2488. Count Subarrays With Median K</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/hard/leetcode2518/" class="">2518. Number of Great Partitions</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/hard/leetcode2573/" class="">2573. Count the Number of Square-Free Subsets</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/hard/leetcode2577/" class="">2577. 在网格图中访问一个格子的最少时间</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/hard/leetcode2584/" class="">2584. Split the Array to Make Coprime Products</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/hard/leetcode2612/" class="">2612. Minimum Reverse Operations</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/hard/leetcode2646/" class="">2646. Minimize the Total Price of the Trips</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/hard/leetcode2713/" class="">2713. Maximum Strictly Increasing Cells in a Matrix</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/hard/leetcode2719/" class="">2719. Count of Integers</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/leetcode/hard/leetcode2742/" class="">2742. Painting the Walls</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-010cc3a6dda69f98986133a7094047b7" class="toggle"  />
    <label for="section-010cc3a6dda69f98986133a7094047b7" class="flex justify-between">
      <a href="../../../../../docs/books/" class="">读书笔记</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-4ed26bb92a4c971f4b8276bfc9e49be9" class="toggle"  />
    <label for="section-4ed26bb92a4c971f4b8276bfc9e49be9" class="flex justify-between">
      <a role="button" class="">社交相关</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../../../../docs/books/social/the-art-of-communication/" class="">沟通的艺术与处世智慧 -- 【美】戴尔*卡耐基</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>











  
<ul>
  
  <li>
    <a href="../../../../../posts/"  >
        Blog
      </a>
  </li>
  
  <li>
    <a href="https://github.com/githubwyb"  target="_blank" rel="noopener">
        Github
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="../../../../../svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>open系统调用</strong>

  <label for="toc-control">
    
    <img src="../../../../../svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#一总述">一、总述</a></li>
    <li><a href="#二代码流程">二、代码流程</a>
      <ul>
        <li><a href="#1-syscall_define3-从系统调用定义开始">1. SYSCALL_DEFINE3 从系统调用定义开始</a>
          <ul>
            <li><a href="#11-先构造如何打开的结构体主要是处理flag">1.1. 先构造如何打开的结构体，主要是处理flag</a></li>
          </ul>
        </li>
        <li><a href="#2-do_sys_openat2-继续调用打开文件">2. do_sys_openat2 继续调用打开文件</a>
          <ul>
            <li><a href="#21-build_open_flags-构建open_flags">2.1. build_open_flags 构建<code>open_flags</code></a></li>
          </ul>
        </li>
        <li><a href="#3-do_filp_open-打开文件的调用">3. do_filp_open 打开文件的调用</a></li>
        <li><a href="#4-do_open-打开文件的最后一步">4. do_open 打开文件的最后一步</a></li>
        <li><a href="#5-vfs_open-虚拟文件系统打开文件">5. vfs_open 虚拟文件系统打开文件</a></li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown"><p>
  <a href="http://edsionte.com/techblog/archives/4476">open()在Linux内核的实现(2)-路径查找</a>

  <a href="https://blog.csdn.net/u012142460/article/details/78932165">详解应用层open函数如何调用到底层驱动中xxx_open函数</a>

  <a href="https://blog.csdn.net/weixin_43408374/article/details/104770835">打开一个文件操作系统做了什么？</a></p>
<h1 id="一总述">
  一、总述
  <a class="anchor" href="#%e4%b8%80%e6%80%bb%e8%bf%b0">#</a>
</h1>
<h1 id="二代码流程">
  二、代码流程
  <a class="anchor" href="#%e4%ba%8c%e4%bb%a3%e7%a0%81%e6%b5%81%e7%a8%8b">#</a>
</h1>
<h2 id="1-syscall_define3-从系统调用定义开始">
  1. SYSCALL_DEFINE3 从系统调用定义开始
  <a class="anchor" href="#1-syscall_define3-%e4%bb%8e%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8%e5%ae%9a%e4%b9%89%e5%bc%80%e5%a7%8b">#</a>
</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#09f;font-style:italic">// fs/open.c
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style="color:#09f;font-style:italic"></span>SYSCALL_DEFINE3(open, <span style="color:#069;font-weight:bold">const</span> <span style="color:#078;font-weight:bold">char</span> __user <span style="color:#555">*</span>, filename, <span style="color:#078;font-weight:bold">int</span>, flags, umode_t, mode)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>	<span style="color:#069;font-weight:bold">if</span> (force_o_largefile())
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>		flags <span style="color:#555">|=</span> O_LARGEFILE;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>	<span style="color:#069;font-weight:bold">return</span> <span style="color:#c0f">do_sys_open</span>(AT_FDCWD, filename, flags, mode);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span><span style="color:#09f;font-style:italic">// fs/open.c
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span><span style="color:#09f;font-style:italic"></span><span style="color:#078;font-weight:bold">long</span> <span style="color:#c0f">do_sys_open</span>(<span style="color:#078;font-weight:bold">int</span> dfd, <span style="color:#069;font-weight:bold">const</span> <span style="color:#078;font-weight:bold">char</span> __user <span style="color:#555">*</span>filename, <span style="color:#078;font-weight:bold">int</span> flags, umode_t mode)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>	<span style="color:#069;font-weight:bold">struct</span> <span style="color:#0a8;font-weight:bold">open_how</span> how <span style="color:#555">=</span> build_open_how(flags, mode);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>	<span style="color:#069;font-weight:bold">return</span> do_sys_openat2(dfd, filename, <span style="color:#555">&amp;</span>how);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>}
</span></span></code></pre></div><h3 id="11-先构造如何打开的结构体主要是处理flag">
  1.1. 先构造如何打开的结构体，主要是处理flag
  <a class="anchor" href="#11-%e5%85%88%e6%9e%84%e9%80%a0%e5%a6%82%e4%bd%95%e6%89%93%e5%bc%80%e7%9a%84%e7%bb%93%e6%9e%84%e4%bd%93%e4%b8%bb%e8%a6%81%e6%98%af%e5%a4%84%e7%90%86flag">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#09f;font-style:italic">// fs/open.c
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style="color:#09f;font-style:italic"></span><span style="color:#099">#define WILL_CREATE(flags)	(flags &amp; (O_CREAT | __O_TMPFILE))
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span><span style="color:#099">#define O_PATH_FLAGS		(O_DIRECTORY | O_NOFOLLOW | O_PATH | O_CLOEXEC)
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span><span style="color:#099"></span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span><span style="color:#069;font-weight:bold">inline</span> <span style="color:#069;font-weight:bold">struct</span> <span style="color:#0a8;font-weight:bold">open_how</span> <span style="color:#c0f">build_open_how</span>(<span style="color:#078;font-weight:bold">int</span> flags, umode_t mode)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>	<span style="color:#069;font-weight:bold">struct</span> <span style="color:#0a8;font-weight:bold">open_how</span> how <span style="color:#555">=</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>		.flags <span style="color:#555">=</span> flags <span style="color:#555">&amp;</span> VALID_OPEN_FLAGS,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>		.mode <span style="color:#555">=</span> mode <span style="color:#555">&amp;</span> S_IALLUGO,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>	};
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>	<span style="color:#09f;font-style:italic">/* O_PATH beats everything else. */</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>	<span style="color:#069;font-weight:bold">if</span> (how.flags <span style="color:#555">&amp;</span> O_PATH)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>		how.flags <span style="color:#555">&amp;=</span> O_PATH_FLAGS;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>	<span style="color:#09f;font-style:italic">/* Modes should only be set for create-like flags. */</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>	<span style="color:#069;font-weight:bold">if</span> (<span style="color:#555">!</span>WILL_CREATE(how.flags))
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>		how.mode <span style="color:#555">=</span> <span style="color:#f60">0</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>	<span style="color:#069;font-weight:bold">return</span> how;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>}
</span></span></code></pre></div><h2 id="2-do_sys_openat2-继续调用打开文件">
  2. do_sys_openat2 继续调用打开文件
  <a class="anchor" href="#2-do_sys_openat2-%e7%bb%a7%e7%bb%ad%e8%b0%83%e7%94%a8%e6%89%93%e5%bc%80%e6%96%87%e4%bb%b6">#</a>
</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#09f;font-style:italic">// fs/open.c
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style="color:#09f;font-style:italic"></span><span style="color:#069;font-weight:bold">static</span> <span style="color:#078;font-weight:bold">long</span> <span style="color:#c0f">do_sys_openat2</span>(<span style="color:#078;font-weight:bold">int</span> dfd, <span style="color:#069;font-weight:bold">const</span> <span style="color:#078;font-weight:bold">char</span> __user <span style="color:#555">*</span>filename,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>			   <span style="color:#069;font-weight:bold">struct</span> <span style="color:#0a8;font-weight:bold">open_how</span> <span style="color:#555">*</span>how)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>	<span style="color:#069;font-weight:bold">struct</span> <span style="color:#0a8;font-weight:bold">open_flags</span> op;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>    <span style="color:#09f;font-style:italic">// 根据open_how构建open_flags结构体，这里fd只是复用为返回值判断用
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span><span style="color:#09f;font-style:italic"></span>	<span style="color:#078;font-weight:bold">int</span> fd <span style="color:#555">=</span> build_open_flags(how, <span style="color:#555">&amp;</span>op);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>	<span style="color:#069;font-weight:bold">struct</span> <span style="color:#0a8;font-weight:bold">filename</span> <span style="color:#555">*</span>tmp;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>	<span style="color:#069;font-weight:bold">if</span> (fd)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>		<span style="color:#069;font-weight:bold">return</span> fd;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>	tmp <span style="color:#555">=</span> getname(filename);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>	<span style="color:#069;font-weight:bold">if</span> (IS_ERR(tmp))
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>		<span style="color:#069;font-weight:bold">return</span> PTR_ERR(tmp);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>    <span style="color:#09f;font-style:italic">// 获取一个未使用的fd
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span><span style="color:#09f;font-style:italic"></span>	fd <span style="color:#555">=</span> get_unused_fd_flags(how<span style="color:#555">-&gt;</span>flags);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>	<span style="color:#069;font-weight:bold">if</span> (fd <span style="color:#555">&gt;=</span> <span style="color:#f60">0</span>) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>        <span style="color:#09f;font-style:italic">// 真正打开文件的函数
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span><span style="color:#09f;font-style:italic"></span>		<span style="color:#069;font-weight:bold">struct</span> <span style="color:#0a8;font-weight:bold">file</span> <span style="color:#555">*</span>f <span style="color:#555">=</span> do_filp_open(dfd, tmp, <span style="color:#555">&amp;</span>op);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>		<span style="color:#069;font-weight:bold">if</span> (IS_ERR(f)) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>			put_unused_fd(fd);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>			fd <span style="color:#555">=</span> PTR_ERR(f);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>		} <span style="color:#069;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>			fsnotify_open(f);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>            <span style="color:#09f;font-style:italic">// 绑定fd和文件结构体
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span><span style="color:#09f;font-style:italic"></span>			fd_install(fd, f);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>		}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>	putname(tmp);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span>	<span style="color:#069;font-weight:bold">return</span> fd;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span>}
</span></span></code></pre></div><h3 id="21-build_open_flags-构建open_flags">
  2.1. build_open_flags 构建<code>open_flags</code>
  <a class="anchor" href="#21-build_open_flags-%e6%9e%84%e5%bb%baopen_flags">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1</span><span><span style="color:#09f;font-style:italic">// fs/open.c
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2</span><span><span style="color:#09f;font-style:italic"></span><span style="color:#069;font-weight:bold">inline</span> <span style="color:#078;font-weight:bold">int</span> <span style="color:#c0f">build_open_flags</span>(<span style="color:#069;font-weight:bold">const</span> <span style="color:#069;font-weight:bold">struct</span> <span style="color:#0a8;font-weight:bold">open_how</span> <span style="color:#555">*</span>how, <span style="color:#069;font-weight:bold">struct</span> <span style="color:#0a8;font-weight:bold">open_flags</span> <span style="color:#555">*</span>op)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3</span><span>{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4</span><span>	u64 flags <span style="color:#555">=</span> how<span style="color:#555">-&gt;</span>flags;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5</span><span>	u64 strip <span style="color:#555">=</span> FMODE_NONOTIFY <span style="color:#555">|</span> O_CLOEXEC;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6</span><span>	<span style="color:#078;font-weight:bold">int</span> lookup_flags <span style="color:#555">=</span> <span style="color:#f60">0</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7</span><span>	<span style="color:#078;font-weight:bold">int</span> acc_mode <span style="color:#555">=</span> ACC_MODE(flags);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9</span><span>	BUILD_BUG_ON_MSG(upper_32_bits(VALID_OPEN_FLAGS),
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10</span><span>			 <span style="color:#c30">&#34;struct open_flags doesn&#39;t yet handle flags &gt; 32 bits&#34;</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12</span><span>	<span style="color:#09f;font-style:italic">/*
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13</span><span><span style="color:#09f;font-style:italic">	 * Strip flags that either shouldn&#39;t be set by userspace like
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14</span><span><span style="color:#09f;font-style:italic">	 * FMODE_NONOTIFY or that aren&#39;t relevant in determining struct
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15</span><span><span style="color:#09f;font-style:italic">	 * open_flags like O_CLOEXEC.
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16</span><span><span style="color:#09f;font-style:italic">	 */</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17</span><span>	flags <span style="color:#555">&amp;=</span> <span style="color:#555">~</span>strip;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19</span><span>	<span style="color:#09f;font-style:italic">/*
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20</span><span><span style="color:#09f;font-style:italic">	 * Older syscalls implicitly clear all of the invalid flags or argument
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21</span><span><span style="color:#09f;font-style:italic">	 * values before calling build_open_flags(), but openat2(2) checks all
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22</span><span><span style="color:#09f;font-style:italic">	 * of its arguments.
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23</span><span><span style="color:#09f;font-style:italic">	 */</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24</span><span>	<span style="color:#069;font-weight:bold">if</span> (flags <span style="color:#555">&amp;</span> <span style="color:#555">~</span>VALID_OPEN_FLAGS)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25</span><span>		<span style="color:#069;font-weight:bold">return</span> <span style="color:#555">-</span>EINVAL;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26</span><span>	<span style="color:#069;font-weight:bold">if</span> (how<span style="color:#555">-&gt;</span>resolve <span style="color:#555">&amp;</span> <span style="color:#555">~</span>VALID_RESOLVE_FLAGS)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27</span><span>		<span style="color:#069;font-weight:bold">return</span> <span style="color:#555">-</span>EINVAL;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29</span><span>	<span style="color:#09f;font-style:italic">/* Scoping flags are mutually exclusive. */</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30</span><span>	<span style="color:#069;font-weight:bold">if</span> ((how<span style="color:#555">-&gt;</span>resolve <span style="color:#555">&amp;</span> RESOLVE_BENEATH) <span style="color:#555">&amp;&amp;</span> (how<span style="color:#555">-&gt;</span>resolve <span style="color:#555">&amp;</span> RESOLVE_IN_ROOT))
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31</span><span>		<span style="color:#069;font-weight:bold">return</span> <span style="color:#555">-</span>EINVAL;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33</span><span>	<span style="color:#09f;font-style:italic">/* Deal with the mode. */</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34</span><span>	<span style="color:#069;font-weight:bold">if</span> (WILL_CREATE(flags)) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35</span><span>		<span style="color:#069;font-weight:bold">if</span> (how<span style="color:#555">-&gt;</span>mode <span style="color:#555">&amp;</span> <span style="color:#555">~</span>S_IALLUGO)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36</span><span>			<span style="color:#069;font-weight:bold">return</span> <span style="color:#555">-</span>EINVAL;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37</span><span>		op<span style="color:#555">-&gt;</span>mode <span style="color:#555">=</span> how<span style="color:#555">-&gt;</span>mode <span style="color:#555">|</span> S_IFREG;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38</span><span>	} <span style="color:#069;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39</span><span>		<span style="color:#069;font-weight:bold">if</span> (how<span style="color:#555">-&gt;</span>mode <span style="color:#555">!=</span> <span style="color:#f60">0</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40</span><span>			<span style="color:#069;font-weight:bold">return</span> <span style="color:#555">-</span>EINVAL;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41</span><span>		op<span style="color:#555">-&gt;</span>mode <span style="color:#555">=</span> <span style="color:#f60">0</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44</span><span>	<span style="color:#09f;font-style:italic">/*
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45</span><span><span style="color:#09f;font-style:italic">	 * In order to ensure programs get explicit errors when trying to use
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46</span><span><span style="color:#09f;font-style:italic">	 * O_TMPFILE on old kernels, O_TMPFILE is implemented such that it
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47</span><span><span style="color:#09f;font-style:italic">	 * looks like (O_DIRECTORY|O_RDWR &amp; ~O_CREAT) to old kernels. But we
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48</span><span><span style="color:#09f;font-style:italic">	 * have to require userspace to explicitly set it.
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49</span><span><span style="color:#09f;font-style:italic">	 */</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50</span><span>	<span style="color:#069;font-weight:bold">if</span> (flags <span style="color:#555">&amp;</span> __O_TMPFILE) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51</span><span>		<span style="color:#069;font-weight:bold">if</span> ((flags <span style="color:#555">&amp;</span> O_TMPFILE_MASK) <span style="color:#555">!=</span> O_TMPFILE)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52</span><span>			<span style="color:#069;font-weight:bold">return</span> <span style="color:#555">-</span>EINVAL;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53</span><span>		<span style="color:#069;font-weight:bold">if</span> (<span style="color:#555">!</span>(acc_mode <span style="color:#555">&amp;</span> MAY_WRITE))
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54</span><span>			<span style="color:#069;font-weight:bold">return</span> <span style="color:#555">-</span>EINVAL;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56</span><span>	<span style="color:#069;font-weight:bold">if</span> (flags <span style="color:#555">&amp;</span> O_PATH) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57</span><span>		<span style="color:#09f;font-style:italic">/* O_PATH only permits certain other flags to be set. */</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58</span><span>		<span style="color:#069;font-weight:bold">if</span> (flags <span style="color:#555">&amp;</span> <span style="color:#555">~</span>O_PATH_FLAGS)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59</span><span>			<span style="color:#069;font-weight:bold">return</span> <span style="color:#555">-</span>EINVAL;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60</span><span>		acc_mode <span style="color:#555">=</span> <span style="color:#f60">0</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63</span><span>	<span style="color:#09f;font-style:italic">/*
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64</span><span><span style="color:#09f;font-style:italic">	 * O_SYNC is implemented as __O_SYNC|O_DSYNC.  As many places only
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65</span><span><span style="color:#09f;font-style:italic">	 * check for O_DSYNC if the need any syncing at all we enforce it&#39;s
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66</span><span><span style="color:#09f;font-style:italic">	 * always set instead of having to deal with possibly weird behaviour
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67</span><span><span style="color:#09f;font-style:italic">	 * for malicious applications setting only __O_SYNC.
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68</span><span><span style="color:#09f;font-style:italic">	 */</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69</span><span>	<span style="color:#069;font-weight:bold">if</span> (flags <span style="color:#555">&amp;</span> __O_SYNC)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70</span><span>		flags <span style="color:#555">|=</span> O_DSYNC;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72</span><span>	op<span style="color:#555">-&gt;</span>open_flag <span style="color:#555">=</span> flags;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74</span><span>	<span style="color:#09f;font-style:italic">/* O_TRUNC implies we need access checks for write permissions */</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75</span><span>	<span style="color:#069;font-weight:bold">if</span> (flags <span style="color:#555">&amp;</span> O_TRUNC)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76</span><span>		acc_mode <span style="color:#555">|=</span> MAY_WRITE;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78</span><span>	<span style="color:#09f;font-style:italic">/* Allow the LSM permission hook to distinguish append
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79</span><span><span style="color:#09f;font-style:italic">	   access from general write access. */</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80</span><span>	<span style="color:#069;font-weight:bold">if</span> (flags <span style="color:#555">&amp;</span> O_APPEND)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81</span><span>		acc_mode <span style="color:#555">|=</span> MAY_APPEND;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83</span><span>	op<span style="color:#555">-&gt;</span>acc_mode <span style="color:#555">=</span> acc_mode;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85</span><span>	op<span style="color:#555">-&gt;</span>intent <span style="color:#555">=</span> flags <span style="color:#555">&amp;</span> O_PATH <span style="color:#555">?</span> <span style="color:#f60">0</span> <span style="color:#555">:</span> LOOKUP_OPEN;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87</span><span>	<span style="color:#069;font-weight:bold">if</span> (flags <span style="color:#555">&amp;</span> O_CREAT) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88</span><span>		op<span style="color:#555">-&gt;</span>intent <span style="color:#555">|=</span> LOOKUP_CREATE;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89</span><span>		<span style="color:#069;font-weight:bold">if</span> (flags <span style="color:#555">&amp;</span> O_EXCL) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90</span><span>			op<span style="color:#555">-&gt;</span>intent <span style="color:#555">|=</span> LOOKUP_EXCL;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91</span><span>			flags <span style="color:#555">|=</span> O_NOFOLLOW;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92</span><span>		}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95</span><span>	<span style="color:#069;font-weight:bold">if</span> (flags <span style="color:#555">&amp;</span> O_DIRECTORY)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96</span><span>		lookup_flags <span style="color:#555">|=</span> LOOKUP_DIRECTORY;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97</span><span>	<span style="color:#069;font-weight:bold">if</span> (<span style="color:#555">!</span>(flags <span style="color:#555">&amp;</span> O_NOFOLLOW))
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98</span><span>		lookup_flags <span style="color:#555">|=</span> LOOKUP_FOLLOW;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100</span><span>	<span style="color:#069;font-weight:bold">if</span> (how<span style="color:#555">-&gt;</span>resolve <span style="color:#555">&amp;</span> RESOLVE_NO_XDEV)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101</span><span>		lookup_flags <span style="color:#555">|=</span> LOOKUP_NO_XDEV;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102</span><span>	<span style="color:#069;font-weight:bold">if</span> (how<span style="color:#555">-&gt;</span>resolve <span style="color:#555">&amp;</span> RESOLVE_NO_MAGICLINKS)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103</span><span>		lookup_flags <span style="color:#555">|=</span> LOOKUP_NO_MAGICLINKS;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104</span><span>	<span style="color:#069;font-weight:bold">if</span> (how<span style="color:#555">-&gt;</span>resolve <span style="color:#555">&amp;</span> RESOLVE_NO_SYMLINKS)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105</span><span>		lookup_flags <span style="color:#555">|=</span> LOOKUP_NO_SYMLINKS;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106</span><span>	<span style="color:#069;font-weight:bold">if</span> (how<span style="color:#555">-&gt;</span>resolve <span style="color:#555">&amp;</span> RESOLVE_BENEATH)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107</span><span>		lookup_flags <span style="color:#555">|=</span> LOOKUP_BENEATH;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108</span><span>	<span style="color:#069;font-weight:bold">if</span> (how<span style="color:#555">-&gt;</span>resolve <span style="color:#555">&amp;</span> RESOLVE_IN_ROOT)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109</span><span>		lookup_flags <span style="color:#555">|=</span> LOOKUP_IN_ROOT;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110</span><span>	<span style="color:#069;font-weight:bold">if</span> (how<span style="color:#555">-&gt;</span>resolve <span style="color:#555">&amp;</span> RESOLVE_CACHED) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111</span><span>		<span style="color:#09f;font-style:italic">/* Don&#39;t bother even trying for create/truncate/tmpfile open */</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112</span><span>		<span style="color:#069;font-weight:bold">if</span> (flags <span style="color:#555">&amp;</span> (O_TRUNC <span style="color:#555">|</span> O_CREAT <span style="color:#555">|</span> O_TMPFILE))
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113</span><span>			<span style="color:#069;font-weight:bold">return</span> <span style="color:#555">-</span>EAGAIN;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114</span><span>		lookup_flags <span style="color:#555">|=</span> LOOKUP_CACHED;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117</span><span>	op<span style="color:#555">-&gt;</span>lookup_flags <span style="color:#555">=</span> lookup_flags;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118</span><span>	<span style="color:#069;font-weight:bold">return</span> <span style="color:#f60">0</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119</span><span>}
</span></span></code></pre></div><h2 id="3-do_filp_open-打开文件的调用">
  3. do_filp_open 打开文件的调用
  <a class="anchor" href="#3-do_filp_open-%e6%89%93%e5%bc%80%e6%96%87%e4%bb%b6%e7%9a%84%e8%b0%83%e7%94%a8">#</a>
</h2>
<ul>
<li>path_openat会申请file结构体的空间，用于返回</li>
<li>link_path_walk找路径的最后一个分量</li>
<li>open_last_lookups对最后一个分量进行处理，会查找文件是否存在，不存在则根据条件创建</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#09f;font-style:italic">// fs/namei.c
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style="color:#09f;font-style:italic"></span><span style="color:#069;font-weight:bold">struct</span> <span style="color:#0a8;font-weight:bold">file</span> <span style="color:#555">*</span><span style="color:#c0f">do_filp_open</span>(<span style="color:#078;font-weight:bold">int</span> dfd, <span style="color:#069;font-weight:bold">struct</span> <span style="color:#0a8;font-weight:bold">filename</span> <span style="color:#555">*</span>pathname,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>		<span style="color:#069;font-weight:bold">const</span> <span style="color:#069;font-weight:bold">struct</span> <span style="color:#0a8;font-weight:bold">open_flags</span> <span style="color:#555">*</span>op)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>	<span style="color:#069;font-weight:bold">struct</span> <span style="color:#0a8;font-weight:bold">nameidata</span> nd;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>	<span style="color:#078;font-weight:bold">int</span> flags <span style="color:#555">=</span> op<span style="color:#555">-&gt;</span>lookup_flags;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>	<span style="color:#069;font-weight:bold">struct</span> <span style="color:#0a8;font-weight:bold">file</span> <span style="color:#555">*</span>filp;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>	set_nameidata(<span style="color:#555">&amp;</span>nd, dfd, pathname, <span style="color:#366">NULL</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>	filp <span style="color:#555">=</span> path_openat(<span style="color:#555">&amp;</span>nd, op, flags <span style="color:#555">|</span> LOOKUP_RCU);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>	<span style="color:#069;font-weight:bold">if</span> (unlikely(filp <span style="color:#555">==</span> ERR_PTR(<span style="color:#555">-</span>ECHILD)))
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>		filp <span style="color:#555">=</span> path_openat(<span style="color:#555">&amp;</span>nd, op, flags);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>	<span style="color:#069;font-weight:bold">if</span> (unlikely(filp <span style="color:#555">==</span> ERR_PTR(<span style="color:#555">-</span>ESTALE)))
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>		filp <span style="color:#555">=</span> path_openat(<span style="color:#555">&amp;</span>nd, op, flags <span style="color:#555">|</span> LOOKUP_REVAL);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>	restore_nameidata();
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>	<span style="color:#069;font-weight:bold">return</span> filp;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span><span style="color:#09f;font-style:italic">// fs/namei.c
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span><span style="color:#09f;font-style:italic"></span><span style="color:#069;font-weight:bold">static</span> <span style="color:#069;font-weight:bold">struct</span> <span style="color:#0a8;font-weight:bold">file</span> <span style="color:#555">*</span><span style="color:#c0f">path_openat</span>(<span style="color:#069;font-weight:bold">struct</span> <span style="color:#0a8;font-weight:bold">nameidata</span> <span style="color:#555">*</span>nd,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>			<span style="color:#069;font-weight:bold">const</span> <span style="color:#069;font-weight:bold">struct</span> <span style="color:#0a8;font-weight:bold">open_flags</span> <span style="color:#555">*</span>op, <span style="color:#078;font-weight:bold">unsigned</span> flags)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>	<span style="color:#069;font-weight:bold">struct</span> <span style="color:#0a8;font-weight:bold">file</span> <span style="color:#555">*</span>file;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>	<span style="color:#078;font-weight:bold">int</span> error;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>    <span style="color:#09f;font-style:italic">// 申请空间
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span><span style="color:#09f;font-style:italic"></span>	file <span style="color:#555">=</span> alloc_empty_file(op<span style="color:#555">-&gt;</span>open_flag, current_cred());
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>	<span style="color:#069;font-weight:bold">if</span> (IS_ERR(file))
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>		<span style="color:#069;font-weight:bold">return</span> file;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>	<span style="color:#069;font-weight:bold">if</span> (unlikely(file<span style="color:#555">-&gt;</span>f_flags <span style="color:#555">&amp;</span> __O_TMPFILE)) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span>		error <span style="color:#555">=</span> do_tmpfile(nd, flags, op, file);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span>	} <span style="color:#069;font-weight:bold">else</span> <span style="color:#069;font-weight:bold">if</span> (unlikely(file<span style="color:#555">-&gt;</span>f_flags <span style="color:#555">&amp;</span> O_PATH)) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span>		error <span style="color:#555">=</span> do_o_path(nd, flags, file);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span>	} <span style="color:#069;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span>		<span style="color:#069;font-weight:bold">const</span> <span style="color:#078;font-weight:bold">char</span> <span style="color:#555">*</span>s <span style="color:#555">=</span> path_init(nd, flags);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span>		<span style="color:#09f;font-style:italic">// link_path_walk找路径的最后一个分量
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span><span><span style="color:#09f;font-style:italic"></span>		<span style="color:#09f;font-style:italic">// open_last_lookups对最后一个分量进行处理，会查找文件是否存在，不存在则根据条件创建
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span><span style="color:#09f;font-style:italic"></span>		<span style="color:#069;font-weight:bold">while</span> (<span style="color:#555">!</span>(error <span style="color:#555">=</span> link_path_walk(s, nd)) <span style="color:#555">&amp;&amp;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span><span>		       (s <span style="color:#555">=</span> open_last_lookups(nd, file, op)) <span style="color:#555">!=</span> <span style="color:#366">NULL</span>)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span>			;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span><span>		<span style="color:#069;font-weight:bold">if</span> (<span style="color:#555">!</span>error)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span><span>			<span style="color:#09f;font-style:italic">// 遍历到后，执行open的后续操作
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span><span><span style="color:#09f;font-style:italic"></span>			error <span style="color:#555">=</span> do_open(nd, file, op);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span><span>		terminate_walk(nd);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span><span>	<span style="color:#069;font-weight:bold">if</span> (likely(<span style="color:#555">!</span>error)) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span><span>		<span style="color:#069;font-weight:bold">if</span> (likely(file<span style="color:#555">-&gt;</span>f_mode <span style="color:#555">&amp;</span> FMODE_OPENED))
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span><span>			<span style="color:#069;font-weight:bold">return</span> file;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span><span>		WARN_ON(<span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span><span>		error <span style="color:#555">=</span> <span style="color:#555">-</span>EINVAL;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span><span>    <span style="color:#09f;font-style:italic">// 此函数减少文件引用计数
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span><span><span style="color:#09f;font-style:italic"></span>	fput(file);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span><span>	<span style="color:#069;font-weight:bold">if</span> (error <span style="color:#555">==</span> <span style="color:#555">-</span>EOPENSTALE) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span><span>		<span style="color:#069;font-weight:bold">if</span> (flags <span style="color:#555">&amp;</span> LOOKUP_RCU)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57</span><span>			error <span style="color:#555">=</span> <span style="color:#555">-</span>ECHILD;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58</span><span>		<span style="color:#069;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59</span><span>			error <span style="color:#555">=</span> <span style="color:#555">-</span>ESTALE;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61</span><span>	<span style="color:#069;font-weight:bold">return</span> ERR_PTR(error);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62</span><span>}
</span></span></code></pre></div><h2 id="4-do_open-打开文件的最后一步">
  4. do_open 打开文件的最后一步
  <a class="anchor" href="#4-do_open-%e6%89%93%e5%bc%80%e6%96%87%e4%bb%b6%e7%9a%84%e6%9c%80%e5%90%8e%e4%b8%80%e6%ad%a5">#</a>
</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span><span style="color:#09f;font-style:italic">// fs/namei.c
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span><span style="color:#09f;font-style:italic"></span><span style="color:#09f;font-style:italic">/*
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span><span style="color:#09f;font-style:italic"> * Handle the last step of open()
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span><span style="color:#09f;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span><span style="color:#069;font-weight:bold">static</span> <span style="color:#078;font-weight:bold">int</span> <span style="color:#c0f">do_open</span>(<span style="color:#069;font-weight:bold">struct</span> <span style="color:#0a8;font-weight:bold">nameidata</span> <span style="color:#555">*</span>nd,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>		   <span style="color:#069;font-weight:bold">struct</span> <span style="color:#0a8;font-weight:bold">file</span> <span style="color:#555">*</span>file, <span style="color:#069;font-weight:bold">const</span> <span style="color:#069;font-weight:bold">struct</span> <span style="color:#0a8;font-weight:bold">open_flags</span> <span style="color:#555">*</span>op)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>	<span style="color:#069;font-weight:bold">struct</span> <span style="color:#0a8;font-weight:bold">user_namespace</span> <span style="color:#555">*</span>mnt_userns;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>	<span style="color:#078;font-weight:bold">int</span> open_flag <span style="color:#555">=</span> op<span style="color:#555">-&gt;</span>open_flag;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>	<span style="color:#078;font-weight:bold">bool</span> do_truncate;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>	<span style="color:#078;font-weight:bold">int</span> acc_mode;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>	<span style="color:#078;font-weight:bold">int</span> error;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>	<span style="color:#069;font-weight:bold">if</span> (<span style="color:#555">!</span>(file<span style="color:#555">-&gt;</span>f_mode <span style="color:#555">&amp;</span> (FMODE_OPENED <span style="color:#555">|</span> FMODE_CREATED))) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>		error <span style="color:#555">=</span> complete_walk(nd);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>		<span style="color:#069;font-weight:bold">if</span> (error)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>			<span style="color:#069;font-weight:bold">return</span> error;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>	<span style="color:#069;font-weight:bold">if</span> (<span style="color:#555">!</span>(file<span style="color:#555">-&gt;</span>f_mode <span style="color:#555">&amp;</span> FMODE_CREATED))
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>		audit_inode(nd<span style="color:#555">-&gt;</span>name, nd<span style="color:#555">-&gt;</span>path.dentry, <span style="color:#f60">0</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>	mnt_userns <span style="color:#555">=</span> mnt_user_ns(nd<span style="color:#555">-&gt;</span>path.mnt);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>	<span style="color:#069;font-weight:bold">if</span> (open_flag <span style="color:#555">&amp;</span> O_CREAT) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>		<span style="color:#069;font-weight:bold">if</span> ((open_flag <span style="color:#555">&amp;</span> O_EXCL) <span style="color:#555">&amp;&amp;</span> <span style="color:#555">!</span>(file<span style="color:#555">-&gt;</span>f_mode <span style="color:#555">&amp;</span> FMODE_CREATED))
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>			<span style="color:#069;font-weight:bold">return</span> <span style="color:#555">-</span>EEXIST;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>		<span style="color:#069;font-weight:bold">if</span> (d_is_dir(nd<span style="color:#555">-&gt;</span>path.dentry))
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>			<span style="color:#069;font-weight:bold">return</span> <span style="color:#555">-</span>EISDIR;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>		error <span style="color:#555">=</span> may_create_in_sticky(mnt_userns, nd,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>					     d_backing_inode(nd<span style="color:#555">-&gt;</span>path.dentry));
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>		<span style="color:#069;font-weight:bold">if</span> (unlikely(error))
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>			<span style="color:#069;font-weight:bold">return</span> error;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span>	<span style="color:#069;font-weight:bold">if</span> ((nd<span style="color:#555">-&gt;</span>flags <span style="color:#555">&amp;</span> LOOKUP_DIRECTORY) <span style="color:#555">&amp;&amp;</span> <span style="color:#555">!</span>d_can_lookup(nd<span style="color:#555">-&gt;</span>path.dentry))
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span>		<span style="color:#069;font-weight:bold">return</span> <span style="color:#555">-</span>ENOTDIR;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span>	do_truncate <span style="color:#555">=</span> <span style="color:#366">false</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span>	acc_mode <span style="color:#555">=</span> op<span style="color:#555">-&gt;</span>acc_mode;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span>	<span style="color:#069;font-weight:bold">if</span> (file<span style="color:#555">-&gt;</span>f_mode <span style="color:#555">&amp;</span> FMODE_CREATED) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span><span>		<span style="color:#09f;font-style:italic">/* Don&#39;t check for write permission, don&#39;t truncate */</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span>		open_flag <span style="color:#555">&amp;=</span> <span style="color:#555">~</span>O_TRUNC;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span><span>		acc_mode <span style="color:#555">=</span> <span style="color:#f60">0</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span>	} <span style="color:#069;font-weight:bold">else</span> <span style="color:#069;font-weight:bold">if</span> (d_is_reg(nd<span style="color:#555">-&gt;</span>path.dentry) <span style="color:#555">&amp;&amp;</span> open_flag <span style="color:#555">&amp;</span> O_TRUNC) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42</span><span>		error <span style="color:#555">=</span> mnt_want_write(nd<span style="color:#555">-&gt;</span>path.mnt);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43</span><span>		<span style="color:#069;font-weight:bold">if</span> (error)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44</span><span>			<span style="color:#069;font-weight:bold">return</span> error;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45</span><span>		do_truncate <span style="color:#555">=</span> <span style="color:#366">true</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47</span><span>	error <span style="color:#555">=</span> may_open(mnt_userns, <span style="color:#555">&amp;</span>nd<span style="color:#555">-&gt;</span>path, acc_mode, open_flag);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48</span><span>	<span style="color:#069;font-weight:bold">if</span> (<span style="color:#555">!</span>error <span style="color:#555">&amp;&amp;</span> <span style="color:#555">!</span>(file<span style="color:#555">-&gt;</span>f_mode <span style="color:#555">&amp;</span> FMODE_OPENED))
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49</span><span>		error <span style="color:#555">=</span> vfs_open(<span style="color:#555">&amp;</span>nd<span style="color:#555">-&gt;</span>path, file);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50</span><span>	<span style="color:#069;font-weight:bold">if</span> (<span style="color:#555">!</span>error)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51</span><span>		error <span style="color:#555">=</span> ima_file_check(file, op<span style="color:#555">-&gt;</span>acc_mode);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52</span><span>	<span style="color:#069;font-weight:bold">if</span> (<span style="color:#555">!</span>error <span style="color:#555">&amp;&amp;</span> do_truncate)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53</span><span>		error <span style="color:#555">=</span> handle_truncate(mnt_userns, file);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54</span><span>	<span style="color:#069;font-weight:bold">if</span> (unlikely(error <span style="color:#555">&gt;</span> <span style="color:#f60">0</span>)) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55</span><span>		WARN_ON(<span style="color:#f60">1</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56</span><span>		error <span style="color:#555">=</span> <span style="color:#555">-</span>EINVAL;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58</span><span>	<span style="color:#069;font-weight:bold">if</span> (do_truncate)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59</span><span>		mnt_drop_write(nd<span style="color:#555">-&gt;</span>path.mnt);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60</span><span>	<span style="color:#069;font-weight:bold">return</span> error;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61</span><span>}
</span></span></code></pre></div><h2 id="5-vfs_open-虚拟文件系统打开文件">
  5. vfs_open 虚拟文件系统打开文件
  <a class="anchor" href="#5-vfs_open-%e8%99%9a%e6%8b%9f%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f%e6%89%93%e5%bc%80%e6%96%87%e4%bb%b6">#</a>
</h2>
<ul>
<li>设置文件操作集</li>
<li>调用操作对应的open函数</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1</span><span><span style="color:#09f;font-style:italic">// fs/open.c
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2</span><span><span style="color:#09f;font-style:italic"></span><span style="color:#09f;font-style:italic">/**
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3</span><span><span style="color:#09f;font-style:italic"> * vfs_open - open the file at the given path
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4</span><span><span style="color:#09f;font-style:italic"> * @path: path to open
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5</span><span><span style="color:#09f;font-style:italic"> * @file: newly allocated file with f_flag initialized
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6</span><span><span style="color:#09f;font-style:italic"> * @cred: credentials to use
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7</span><span><span style="color:#09f;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8</span><span><span style="color:#078;font-weight:bold">int</span> <span style="color:#c0f">vfs_open</span>(<span style="color:#069;font-weight:bold">const</span> <span style="color:#069;font-weight:bold">struct</span> <span style="color:#0a8;font-weight:bold">path</span> <span style="color:#555">*</span>path, <span style="color:#069;font-weight:bold">struct</span> <span style="color:#0a8;font-weight:bold">file</span> <span style="color:#555">*</span>file)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9</span><span>{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10</span><span>	file<span style="color:#555">-&gt;</span>f_path <span style="color:#555">=</span> <span style="color:#555">*</span>path;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11</span><span>	<span style="color:#069;font-weight:bold">return</span> do_dentry_open(file, d_backing_inode(path<span style="color:#555">-&gt;</span>dentry), <span style="color:#366">NULL</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12</span><span>}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14</span><span><span style="color:#09f;font-style:italic">// fs/open.c
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15</span><span><span style="color:#09f;font-style:italic"></span><span style="color:#069;font-weight:bold">static</span> <span style="color:#078;font-weight:bold">int</span> <span style="color:#c0f">do_dentry_open</span>(<span style="color:#069;font-weight:bold">struct</span> <span style="color:#0a8;font-weight:bold">file</span> <span style="color:#555">*</span>f,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16</span><span>			  <span style="color:#069;font-weight:bold">struct</span> <span style="color:#0a8;font-weight:bold">inode</span> <span style="color:#555">*</span>inode,
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17</span><span>			  <span style="color:#078;font-weight:bold">int</span> (<span style="color:#555">*</span>open)(<span style="color:#069;font-weight:bold">struct</span> <span style="color:#0a8;font-weight:bold">inode</span> <span style="color:#555">*</span>, <span style="color:#069;font-weight:bold">struct</span> <span style="color:#0a8;font-weight:bold">file</span> <span style="color:#555">*</span>))
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18</span><span>{
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19</span><span>	<span style="color:#069;font-weight:bold">static</span> <span style="color:#069;font-weight:bold">const</span> <span style="color:#069;font-weight:bold">struct</span> <span style="color:#0a8;font-weight:bold">file_operations</span> empty_fops <span style="color:#555">=</span> {};
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20</span><span>	<span style="color:#078;font-weight:bold">int</span> error;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22</span><span>	path_get(<span style="color:#555">&amp;</span>f<span style="color:#555">-&gt;</span>f_path);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23</span><span>	f<span style="color:#555">-&gt;</span>f_inode <span style="color:#555">=</span> inode;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24</span><span>	f<span style="color:#555">-&gt;</span>f_mapping <span style="color:#555">=</span> inode<span style="color:#555">-&gt;</span>i_mapping;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25</span><span>	f<span style="color:#555">-&gt;</span>f_wb_err <span style="color:#555">=</span> filemap_sample_wb_err(f<span style="color:#555">-&gt;</span>f_mapping);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26</span><span>	f<span style="color:#555">-&gt;</span>f_sb_err <span style="color:#555">=</span> file_sample_sb_err(f);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28</span><span>	<span style="color:#069;font-weight:bold">if</span> (unlikely(f<span style="color:#555">-&gt;</span>f_flags <span style="color:#555">&amp;</span> O_PATH)) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29</span><span>		f<span style="color:#555">-&gt;</span>f_mode <span style="color:#555">=</span> FMODE_PATH <span style="color:#555">|</span> FMODE_OPENED;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30</span><span>		f<span style="color:#555">-&gt;</span>f_op <span style="color:#555">=</span> <span style="color:#555">&amp;</span>empty_fops;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31</span><span>		<span style="color:#069;font-weight:bold">return</span> <span style="color:#f60">0</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34</span><span>	<span style="color:#069;font-weight:bold">if</span> (f<span style="color:#555">-&gt;</span>f_mode <span style="color:#555">&amp;</span> FMODE_WRITE <span style="color:#555">&amp;&amp;</span> <span style="color:#555">!</span>special_file(inode<span style="color:#555">-&gt;</span>i_mode)) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35</span><span>		error <span style="color:#555">=</span> get_write_access(inode);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36</span><span>		<span style="color:#069;font-weight:bold">if</span> (unlikely(error))
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37</span><span>			<span style="color:#069;font-weight:bold">goto</span> cleanup_file;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38</span><span>		error <span style="color:#555">=</span> __mnt_want_write(f<span style="color:#555">-&gt;</span>f_path.mnt);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39</span><span>		<span style="color:#069;font-weight:bold">if</span> (unlikely(error)) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40</span><span>			put_write_access(inode);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41</span><span>			<span style="color:#069;font-weight:bold">goto</span> cleanup_file;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42</span><span>		}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43</span><span>		f<span style="color:#555">-&gt;</span>f_mode <span style="color:#555">|=</span> FMODE_WRITER;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46</span><span>	<span style="color:#09f;font-style:italic">/* POSIX.1-2008/SUSv4 Section XSI 2.9.7 */</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47</span><span>	<span style="color:#069;font-weight:bold">if</span> (S_ISREG(inode<span style="color:#555">-&gt;</span>i_mode) <span style="color:#555">||</span> S_ISDIR(inode<span style="color:#555">-&gt;</span>i_mode))
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48</span><span>		f<span style="color:#555">-&gt;</span>f_mode <span style="color:#555">|=</span> FMODE_ATOMIC_POS;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50</span><span>	<span style="color:#09f;font-style:italic">// 设置文件相关的方法
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51</span><span><span style="color:#09f;font-style:italic"></span>	f<span style="color:#555">-&gt;</span>f_op <span style="color:#555">=</span> fops_get(inode<span style="color:#555">-&gt;</span>i_fop);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52</span><span>	<span style="color:#069;font-weight:bold">if</span> (WARN_ON(<span style="color:#555">!</span>f<span style="color:#555">-&gt;</span>f_op)) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53</span><span>		error <span style="color:#555">=</span> <span style="color:#555">-</span>ENODEV;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54</span><span>		<span style="color:#069;font-weight:bold">goto</span> cleanup_all;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57</span><span>	error <span style="color:#555">=</span> security_file_open(f);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58</span><span>	<span style="color:#069;font-weight:bold">if</span> (error)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59</span><span>		<span style="color:#069;font-weight:bold">goto</span> cleanup_all;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61</span><span>	error <span style="color:#555">=</span> break_lease(locks_inode(f), f<span style="color:#555">-&gt;</span>f_flags);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62</span><span>	<span style="color:#069;font-weight:bold">if</span> (error)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63</span><span>		<span style="color:#069;font-weight:bold">goto</span> cleanup_all;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65</span><span>	<span style="color:#09f;font-style:italic">/* normally all 3 are set; -&gt;open() can clear them if needed */</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66</span><span>	f<span style="color:#555">-&gt;</span>f_mode <span style="color:#555">|=</span> FMODE_LSEEK <span style="color:#555">|</span> FMODE_PREAD <span style="color:#555">|</span> FMODE_PWRITE;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67</span><span>	<span style="color:#09f;font-style:italic">// 这里找对应的f_op中的open进行调用
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68</span><span><span style="color:#09f;font-style:italic"></span>	<span style="color:#069;font-weight:bold">if</span> (<span style="color:#555">!</span>open)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69</span><span>		open <span style="color:#555">=</span> f<span style="color:#555">-&gt;</span>f_op<span style="color:#555">-&gt;</span>open;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70</span><span>	<span style="color:#069;font-weight:bold">if</span> (open) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71</span><span>		error <span style="color:#555">=</span> open(inode, f);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72</span><span>		<span style="color:#069;font-weight:bold">if</span> (error)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73</span><span>			<span style="color:#069;font-weight:bold">goto</span> cleanup_all;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75</span><span>	<span style="color:#09f;font-style:italic">// 设置文件打开标记
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76</span><span><span style="color:#09f;font-style:italic"></span>	f<span style="color:#555">-&gt;</span>f_mode <span style="color:#555">|=</span> FMODE_OPENED;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77</span><span>	<span style="color:#069;font-weight:bold">if</span> ((f<span style="color:#555">-&gt;</span>f_mode <span style="color:#555">&amp;</span> (FMODE_READ <span style="color:#555">|</span> FMODE_WRITE)) <span style="color:#555">==</span> FMODE_READ)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78</span><span>		i_readcount_inc(inode);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79</span><span>	<span style="color:#069;font-weight:bold">if</span> ((f<span style="color:#555">-&gt;</span>f_mode <span style="color:#555">&amp;</span> FMODE_READ) <span style="color:#555">&amp;&amp;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80</span><span>	     likely(f<span style="color:#555">-&gt;</span>f_op<span style="color:#555">-&gt;</span>read <span style="color:#555">||</span> f<span style="color:#555">-&gt;</span>f_op<span style="color:#555">-&gt;</span>read_iter))
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81</span><span>		f<span style="color:#555">-&gt;</span>f_mode <span style="color:#555">|=</span> FMODE_CAN_READ;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82</span><span>	<span style="color:#069;font-weight:bold">if</span> ((f<span style="color:#555">-&gt;</span>f_mode <span style="color:#555">&amp;</span> FMODE_WRITE) <span style="color:#555">&amp;&amp;</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83</span><span>	     likely(f<span style="color:#555">-&gt;</span>f_op<span style="color:#555">-&gt;</span>write <span style="color:#555">||</span> f<span style="color:#555">-&gt;</span>f_op<span style="color:#555">-&gt;</span>write_iter))
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84</span><span>		f<span style="color:#555">-&gt;</span>f_mode <span style="color:#555">|=</span> FMODE_CAN_WRITE;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85</span><span>	<span style="color:#069;font-weight:bold">if</span> (f<span style="color:#555">-&gt;</span>f_mapping<span style="color:#555">-&gt;</span>a_ops <span style="color:#555">&amp;&amp;</span> f<span style="color:#555">-&gt;</span>f_mapping<span style="color:#555">-&gt;</span>a_ops<span style="color:#555">-&gt;</span>direct_IO)
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86</span><span>		f<span style="color:#555">-&gt;</span>f_mode <span style="color:#555">|=</span> FMODE_CAN_ODIRECT;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88</span><span>	f<span style="color:#555">-&gt;</span>f_flags <span style="color:#555">&amp;=</span> <span style="color:#555">~</span>(O_CREAT <span style="color:#555">|</span> O_EXCL <span style="color:#555">|</span> O_NOCTTY <span style="color:#555">|</span> O_TRUNC);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90</span><span>	file_ra_state_init(<span style="color:#555">&amp;</span>f<span style="color:#555">-&gt;</span>f_ra, f<span style="color:#555">-&gt;</span>f_mapping<span style="color:#555">-&gt;</span>host<span style="color:#555">-&gt;</span>i_mapping);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92</span><span>	<span style="color:#069;font-weight:bold">if</span> ((f<span style="color:#555">-&gt;</span>f_flags <span style="color:#555">&amp;</span> O_DIRECT) <span style="color:#555">&amp;&amp;</span> <span style="color:#555">!</span>(f<span style="color:#555">-&gt;</span>f_mode <span style="color:#555">&amp;</span> FMODE_CAN_ODIRECT))
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93</span><span>		<span style="color:#069;font-weight:bold">return</span> <span style="color:#555">-</span>EINVAL;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95</span><span>	<span style="color:#09f;font-style:italic">/*
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96</span><span><span style="color:#09f;font-style:italic">	 * XXX: Huge page cache doesn&#39;t support writing yet. Drop all page
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97</span><span><span style="color:#09f;font-style:italic">	 * cache for this file before processing writes.
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98</span><span><span style="color:#09f;font-style:italic">	 */</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99</span><span>	<span style="color:#069;font-weight:bold">if</span> (f<span style="color:#555">-&gt;</span>f_mode <span style="color:#555">&amp;</span> FMODE_WRITE) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100</span><span>		<span style="color:#09f;font-style:italic">/*
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101</span><span><span style="color:#09f;font-style:italic">		 * Paired with smp_mb() in collapse_file() to ensure nr_thps
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102</span><span><span style="color:#09f;font-style:italic">		 * is up to date and the update to i_writecount by
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103</span><span><span style="color:#09f;font-style:italic">		 * get_write_access() is visible. Ensures subsequent insertion
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104</span><span><span style="color:#09f;font-style:italic">		 * of THPs into the page cache will fail.
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105</span><span><span style="color:#09f;font-style:italic">		 */</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106</span><span>		smp_mb();
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107</span><span>		<span style="color:#069;font-weight:bold">if</span> (filemap_nr_thps(inode<span style="color:#555">-&gt;</span>i_mapping)) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108</span><span>			<span style="color:#069;font-weight:bold">struct</span> <span style="color:#0a8;font-weight:bold">address_space</span> <span style="color:#555">*</span>mapping <span style="color:#555">=</span> inode<span style="color:#555">-&gt;</span>i_mapping;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">110</span><span>			filemap_invalidate_lock(inode<span style="color:#555">-&gt;</span>i_mapping);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">111</span><span>			<span style="color:#09f;font-style:italic">/*
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">112</span><span><span style="color:#09f;font-style:italic">			 * unmap_mapping_range just need to be called once
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">113</span><span><span style="color:#09f;font-style:italic">			 * here, because the private pages is not need to be
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">114</span><span><span style="color:#09f;font-style:italic">			 * unmapped mapping (e.g. data segment of dynamic
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">115</span><span><span style="color:#09f;font-style:italic">			 * shared libraries here).
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">116</span><span><span style="color:#09f;font-style:italic">			 */</span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">117</span><span>			unmap_mapping_range(mapping, <span style="color:#f60">0</span>, <span style="color:#f60">0</span>, <span style="color:#f60">0</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">118</span><span>			truncate_inode_pages(mapping, <span style="color:#f60">0</span>);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">119</span><span>			filemap_invalidate_unlock(inode<span style="color:#555">-&gt;</span>i_mapping);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">120</span><span>		}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">121</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">122</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">123</span><span>	<span style="color:#069;font-weight:bold">return</span> <span style="color:#f60">0</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">124</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">125</span><span><span style="color:#99f">cleanup_all</span>:
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">126</span><span>	<span style="color:#069;font-weight:bold">if</span> (WARN_ON_ONCE(error <span style="color:#555">&gt;</span> <span style="color:#f60">0</span>))
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">127</span><span>		error <span style="color:#555">=</span> <span style="color:#555">-</span>EINVAL;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">128</span><span>	fops_put(f<span style="color:#555">-&gt;</span>f_op);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">129</span><span>	<span style="color:#069;font-weight:bold">if</span> (f<span style="color:#555">-&gt;</span>f_mode <span style="color:#555">&amp;</span> FMODE_WRITER) {
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">130</span><span>		put_write_access(inode);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">131</span><span>		__mnt_drop_write(f<span style="color:#555">-&gt;</span>f_path.mnt);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">132</span><span>	}
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">133</span><span><span style="color:#99f">cleanup_file</span>:
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">134</span><span>	path_put(<span style="color:#555">&amp;</span>f<span style="color:#555">-&gt;</span>f_path);
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">135</span><span>	f<span style="color:#555">-&gt;</span>f_path.mnt <span style="color:#555">=</span> <span style="color:#366">NULL</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">136</span><span>	f<span style="color:#555">-&gt;</span>f_path.dentry <span style="color:#555">=</span> <span style="color:#366">NULL</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">137</span><span>	f<span style="color:#555">-&gt;</span>f_inode <span style="color:#555">=</span> <span style="color:#366">NULL</span>;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">138</span><span>	<span style="color:#069;font-weight:bold">return</span> error;
</span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">139</span><span>}
</span></span></code></pre></div></article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#一总述">一、总述</a></li>
    <li><a href="#二代码流程">二、代码流程</a>
      <ul>
        <li><a href="#1-syscall_define3-从系统调用定义开始">1. SYSCALL_DEFINE3 从系统调用定义开始</a>
          <ul>
            <li><a href="#11-先构造如何打开的结构体主要是处理flag">1.1. 先构造如何打开的结构体，主要是处理flag</a></li>
          </ul>
        </li>
        <li><a href="#2-do_sys_openat2-继续调用打开文件">2. do_sys_openat2 继续调用打开文件</a>
          <ul>
            <li><a href="#21-build_open_flags-构建open_flags">2.1. build_open_flags 构建<code>open_flags</code></a></li>
          </ul>
        </li>
        <li><a href="#3-do_filp_open-打开文件的调用">3. do_filp_open 打开文件的调用</a></li>
        <li><a href="#4-do_open-打开文件的最后一步">4. do_open 打开文件的最后一步</a></li>
        <li><a href="#5-vfs_open-虚拟文件系统打开文件">5. vfs_open 虚拟文件系统打开文件</a></li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












